{"version":3,"sources":["../../../src/utils/dev-ssr/develop-html-route.ts"],"names":["route","app","program","store","get","req","res","next","pathObj","getState","decodeURI","path","htmlActivity","report","phantomActivity","start","renderResponse","page","skipSsr","query","htmlComponentRendererPath","directory","status","send","error","id","filePath","filename","location","line","column","row","context","errorHtml","message","codeFrame","end"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AAEO,MAAMA,KAAK,GAAG,CAAC;AAAEC,EAAAA,GAAF;AAAOC,EAAAA,OAAP;AAAgBC,EAAAA;AAAhB,CAAD,KACnB;AACAF,GAAG,CAACG,GAAJ,CAAS,GAAT,EAAa,OAAOC,GAAP,EAAYC,GAAZ,EAAiBC,IAAjB,KAA0B;AACrC,2CAAoB,6BAApB;AAEA,QAAMC,OAAO,GAAG,oCAAeL,KAAK,CAACM,QAAN,EAAf,EAAiCC,SAAS,CAACL,GAAG,CAACM,IAAL,CAA1C,CAAhB;;AAEA,MAAI,CAACH,OAAL,EAAc;AACZ,WAAOD,IAAI,EAAX;AACD;;AAED,QAAM,iDAAqBC,OAAO,CAACG,IAA7B,EAAmCL,GAAnC,CAAN;;AAEA,QAAMM,YAAY,GAAGC,kBAAOC,eAAP,CAAwB,wBAAxB,EAAiD,EAAjD,CAArB;;AACAF,EAAAA,YAAY,CAACG,KAAb;;AAEA,MAAI;AACF,UAAMC,cAAc,GAAG,MAAM,kCAAc;AACzCL,MAAAA,IAAI,EAAEH,OAAO,CAACG,IAD2B;AAEzCM,MAAAA,IAAI,EAAET,OAFmC;AAGzCU,MAAAA,OAAO,EAAEb,GAAG,CAACc,KAAJ,CAAW,UAAX,KAAyB,KAHO;AAIzChB,MAAAA,KAJyC;AAKzCiB,MAAAA,yBAAyB,EAAG,GAAElB,OAAO,CAACmB,SAAU,wBALP;AAMzCA,MAAAA,SAAS,EAAEnB,OAAO,CAACmB;AANsB,KAAd,CAA7B;AAQAf,IAAAA,GAAG,CAACgB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBP,cAArB;AACD,GAVD,CAUE,OAAOQ,KAAP,EAAc;AACd;AACA;AACA;AACA,QAAIA,KAAK,KAAM,UAAf,EAA0B;AACxB,aAAOjB,IAAI,EAAX;AACD;;AAEDM,sBAAOW,KAAP,CAAa;AACXC,MAAAA,EAAE,EAAG,OADM;AAEXC,MAAAA,QAAQ,EAAEF,KAAK,CAACG,QAFL;AAGXC,MAAAA,QAAQ,EAAE;AACRb,QAAAA,KAAK,EAAE;AACLc,UAAAA,IAAI,EAAEL,KAAK,CAACK,IADP;AAELC,UAAAA,MAAM,EAAEN,KAAK,CAACO;AAFT;AADC,OAHC;AASXC,MAAAA,OAAO,EAAE;AACPrB,QAAAA,IAAI,EAAEH,OAAO,CAACG,IADP;AAEPe,QAAAA,QAAQ,EAAEF,KAAK,CAACG,QAFT;AAGPE,QAAAA,IAAI,EAAEL,KAAK,CAACK,IAHL;AAIPC,QAAAA,MAAM,EAAEN,KAAK,CAACO;AAJP;AATE,KAAb;;AAgBA,QAAIE,SAAS,GAAI;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAiDzB,OAAO,CAACG,IAAK;AAC9D,kDAAkDa,KAAK,CAACG,QAAS;AACjE;AACA;AACA,6EAA6EH,KAAK,CAACU,OAAQ;AAC3F,SAtGM;;AAwGA,QAAIV,KAAK,CAACW,SAAV,EAAqB;AACnBF,MAAAA,SAAS,IAAK,QAAOT,KAAK,CAACW,SAAU,QAArC;AACD,KAlIa,CAoId;;;AACAF,IAAAA,SAAS,IAAK;AACpB;AACA,+HAFM,CArIc,CAyId;;AACAA,IAAAA,SAAS,IAAK;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAnBM;AAoBA3B,IAAAA,GAAG,CAACgB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBU,SAArB;AACD;;AAEDrB,EAAAA,YAAY,CAACwB,GAAb,GAzLqC,CA2LrC;;AACA,SAAO,IAAP;AACD,CA7LD,CAFK","sourcesContent":["import report from \"gatsby-cli/lib/reporter\"\nimport { trackFeatureIsUsed } from \"gatsby-telemetry\"\n\nimport { findPageByPath } from \"../find-page-by-path\"\nimport { renderDevHTML } from \"./render-dev-html\"\nimport { appendPreloadHeaders } from \"../develop-preload-headers\"\n\nexport const route = ({ app, program, store }): any =>\n  // Render an HTML page and serve it.\n  app.get(`*`, async (req, res, next) => {\n    trackFeatureIsUsed(`GATSBY_EXPERIMENTAL_DEV_SSR`)\n\n    const pathObj = findPageByPath(store.getState(), decodeURI(req.path))\n\n    if (!pathObj) {\n      return next()\n    }\n\n    await appendPreloadHeaders(pathObj.path, res)\n\n    const htmlActivity = report.phantomActivity(`building HTML for path`, {})\n    htmlActivity.start()\n\n    try {\n      const renderResponse = await renderDevHTML({\n        path: pathObj.path,\n        page: pathObj,\n        skipSsr: req.query[`skip-ssr`] || false,\n        store,\n        htmlComponentRendererPath: `${program.directory}/public/render-page.js`,\n        directory: program.directory,\n      })\n      res.status(200).send(renderResponse)\n    } catch (error) {\n      // THe page errored but couldn't read the page component.\n      // This is a race condition when a page is deleted but its requested\n      // immediately after before anything can recompile.\n      if (error === `404 page`) {\n        return next()\n      }\n\n      report.error({\n        id: `11614`,\n        filePath: error.filename,\n        location: {\n          start: {\n            line: error.line,\n            column: error.row,\n          },\n        },\n        context: {\n          path: pathObj.path,\n          filePath: error.filename,\n          line: error.line,\n          column: error.row,\n        },\n      })\n      let errorHtml = `<head>\n       <title>Develop SSR Error</title>\n       <style>\n          * {\n            --gatsby: #663399;\n            --gatsbyLight: #9158ca;\n            --dimmedWhite: rgba(255, 255, 255, 0.8);\n            --white: #ffffff;\n            --black: #000000;\n            --color-ansi-selection: rgba(95, 126, 151, 0.48);\n            --color-ansi-bg: #fafafa;\n            --color-ansi-fg: #545454;\n            --color-ansi-white: #969896;\n            --color-ansi-black: #141414;\n            --color-ansi-blue: #183691;\n            --color-ansi-cyan: #007faa;\n            --color-ansi-green: #008000;\n            --color-ansi-magenta: #795da3;\n            --color-ansi-red: #d91e18;\n            --color-ansi-yellow: #aa5d00;\n            --color-ansi-bright-white: #ffffff;\n            --color-ansi-bright-black: #545454;\n            --color-ansi-bright-blue: #183691;\n            --color-ansi-bright-cyan: #007faa;\n            --color-ansi-bright-green: #008000;\n            --color-ansi-bright-magenta: #795da3;\n            --color-ansi-bright-red: #d91e18;\n            --color-ansi-bright-yellow: #aa5d00;\n            --radii: 5px;\n            --z-index-normal: 5;\n            --z-index-elevated: 10;\n            --space: 1.5em;\n            --space-sm: 1em;\n            --space-lg: 2.5em;\n          }\n          [data-gatsby-overlay=\"backdrop\"] {\n            background: rgba(72, 67, 79, 0.5);\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            height: 100%;\n            width: 100%;\n            z-index: var(--z-index-normal);\n            backdrop-filter: blur(10px);\n          }\n          body {\n            font: 18px/1.5 -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto,\n              Helvetica, Arial, sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\",\n              \"Segoe UI Symbol\" !important;\n            background: var(--color-ansi-bright-white);\n            padding: var(--space);\n            overflow: auto;\n          }\n          h1,\n          h2,\n          h3 {\n            display: flex;\n            align-items: center;\n            color: var(--dimmedWhite);\n            background: var(--gatsby);\n            padding: var(--space);\n            border-top-left-radius: var(--radii);\n            border-top-right-radius: var(--radii);\n          }\n          code {\n            font-family: Consolas, \"Andale Mono WT\", \"Andale Mono\", \"Lucida Console\", \"Lucida Sans Typewriter\", \"DejaVu Sans Mono\", \"Bitstream Vera Sans Mono\", \"Liberation Mono\", \"Nimbus Mono L\", Monaco, \"Courier New\", Courier, monospace;\n          }\n          pre {\n            margin: 0;\n            color: var(--color-ansi-fg);\n            padding: var(--space-sm);\n            border-radius: var(--radii);\n          }\n          button {\n            cursor: pointer;\n            border: 1px;\n            padding: 10px;\n            background-color: var(--gatsbyLight);\n            color: var(--white);\n            appearance: none;\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: var(--radii);\n          }\n        </style>\n       </head>\n        <h1>Error</h1>\n        <h2>The page didn't server render (SSR) correctly</h2>\n        <p style=\"padding-left: var(--space-sm);\">\n          React components in Gatsby must render successfully in the browser and in a\n          node.js environment. When we tried to render your page component in\n          node.js, it errored.\n        </p>\n        <ul>\n          <li><strong>URL path:</strong> <code>${pathObj.path}</code></li>\n          <li><strong>File path:</strong> <code>${error.filename}</code></li>\n        </ul>\n        <h3>error</h3>\n        <code style=\"padding: var(--space);padding-left: var(--space-sm);\">${error.message}</code>\n        `\n\n      if (error.codeFrame) {\n        errorHtml += `<pre>${error.codeFrame}</pre>`\n      }\n\n      // Add link to help page\n      errorHtml += `\n      <p>For help debugging SSR errors, see this docs page: <a\n      href=\"https://www.gatsbyjs.com/docs/debugging-html-builds/\">https://www.gatsbyjs.com/docs/debugging-html-builds/</a></p>`\n\n      // Add skip ssr button\n      errorHtml += `\n        <h3>Skip SSR</h3>\n        <p style=\"padding-left: var(--space-sm);\">\n        If you don't wish to fix the SSR error at the moment, press the\n        button below to reload the page without attempting SSR</p>\n        <p style=\"padding-left: var(--space-sm);\">\n        <strong>Note</strong>: this error will show up in when you build your site so must be fixed before then.</p>\n        <p style=\"padding-left: var(--space-sm);\">\n        <strong>Caveat</strong>: SSR errors in module scope i.e. outside of your components can't be skipped so will need fixed before you can continue</p>\n        <button style=\"margin-left: var(--space-sm);\" onclick='refreshWithQueryString()'>Skip SSR</button>\n        <script>\n          function refreshWithQueryString() {\n            if ('URLSearchParams' in window) {\n              var searchParams = new URLSearchParams(window.location.search);\n              searchParams.set(\"skip-ssr\", \"true\");\n              window.location.search = searchParams.toString();\n            }\n          }\n          </script>\n        `\n      res.status(500).send(errorHtml)\n    }\n\n    htmlActivity.end()\n\n    // Make eslint happy\n    return null\n  })\n"],"file":"develop-html-route.js"}