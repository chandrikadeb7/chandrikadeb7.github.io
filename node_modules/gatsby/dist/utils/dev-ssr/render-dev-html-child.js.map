{"version":3,"sources":["../../../src/utils/dev-ssr/render-dev-html-child.js"],"names":["require","install","codeFrameColumns","ansiHTML","fs","sysPath","getPosition","stackObject","filename","line","row","filteredStack","filter","s","test","splitLine","length","match","split","splitLength","Number","err","colors","background","text","green","darkGreen","comment","keyword","yellow","parseError","directory","componentPath","stack","position","join","slice","splitMessage","message","type","name","trueFileName","includes","data","relative","code","readFileSync","setColors","reset","black","red","blue","magenta","cyan","lightgrey","darkgrey","codeFrame","start","column","forceColor","e","console","log","exports","renderHTML","path","htmlComponentRendererPath","isClientOnlyPage","Promise","resolve","reject","htmlComponentRenderer","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","default","_throwAway","htmlString","regex","moduleBuildFailed","error","deleteModuleCache","cache","warmup"],"mappings":"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","sourcesContent":["require(`source-map-support`).install()\nconst { codeFrameColumns } = require(`@babel/code-frame`)\nconst ansiHTML = require(`ansi-html`)\nconst fs = require(`fs-extra`)\nconst sysPath = require(`path`)\n\nconst getPosition = function (stackObject) {\n  let filename\n  let line\n  let row\n  // Because the JavaScript error stack has not yet been standardized,\n  // wrap the stack parsing in a try/catch for a soft fail if an\n  // unexpected stack is encountered.\n  try {\n    const filteredStack = stackObject.filter(function (s) {\n      return /\\(.+?\\)$/.test(s)\n    })\n    let splitLine\n    // For current Node & Chromium Error stacks\n    if (filteredStack.length > 0) {\n      splitLine = filteredStack[0].match(/(?:\\()(.+?)(?:\\))$/)[1].split(`:`)\n      // For older, future, or otherwise unexpected stacks\n    } else {\n      splitLine = stackObject[0].split(`:`)\n    }\n    const splitLength = splitLine.length\n    filename = splitLine[splitLength - 3]\n    line = Number(splitLine[splitLength - 2])\n    row = Number(splitLine[splitLength - 1])\n  } catch (err) {\n    filename = ``\n    line = 0\n    row = 0\n  }\n  return {\n    filename: filename,\n    line: line,\n    row: row,\n  }\n}\n// Colors taken from Gatsby's design tokens\n// https://github.com/gatsbyjs/gatsby/blob/d8acab3a135fa8250a0eb3a47c67300dde6eae32/packages/gatsby-design-tokens/src/colors.js#L185-L205\nconst colors = {\n  background: `fdfaf6`,\n  text: `452475`,\n  green: `137886`,\n  darkGreen: `006500`,\n  comment: `527713`,\n  keyword: `096fb3`,\n  yellow: `DB3A00`,\n}\n\n// Code borrowed and modified from https://github.com/watilde/parse-error\nconst parseError = function ({ err, directory, componentPath }) {\n  const stack = err.stack ? err.stack : ``\n  const stackObject = stack.split(`\\n`)\n  const position = getPosition(stackObject)\n\n  // Remove the `/lib/` added by webpack\n  const filename = sysPath.join(\n    directory,\n    // Don't need to use path.sep as webpack always uses a single forward slash\n    // as a path separator.\n    ...position.filename.split(`/`).slice(2)\n  )\n\n  const splitMessage = err.message ? err.message.split(`\\n`) : [``]\n  const message = splitMessage[splitMessage.length - 1]\n  const type = err.type ? err.type : err.name\n\n  // We prefer the file path from the stack trace as the error might not be in the\n  // component â€” but if source-maps fail and we just get public/render-page.js as\n  // the file, we fall back on the component filepath as at least the user\n  // will have that.\n  const trueFileName = filename.includes(`render-page`)\n    ? componentPath\n    : filename\n  const data = {\n    filename: sysPath.relative(directory, trueFileName),\n    message: message,\n    type: type,\n    stack: stack,\n  }\n\n  // Try to generate a codeFrame\n  try {\n    const code = fs.readFileSync(filename, `utf-8`)\n    const line = position.line\n    const row = position.row\n    ansiHTML.setColors({\n      reset: [colors.text, `ffffff`], // [FOREGROUND-COLOR, BACKGROUND-COLOR]\n      black: `aaa`, // String\n      red: colors.keyword,\n      green: colors.green,\n      yellow: colors.yellow,\n      blue: `eee`,\n      magenta: `fff`,\n      cyan: colors.darkGreen,\n      lightgrey: `888`,\n      darkgrey: colors.comment,\n    })\n    const codeFrame = ansiHTML(\n      codeFrameColumns(\n        code,\n        {\n          start: { line: line, column: row },\n        },\n        { forceColor: true }\n      )\n    )\n\n    data.line = line\n    data.row = row\n    data.codeFrame = codeFrame\n  } catch (e) {\n    console.log(\n      `Couldn't read the file ${filename}, possibly due to source maps failing`\n    )\n    console.log(`original error`, err)\n  }\n\n  return data\n}\n\nexports.parseError = parseError\n\nexports.renderHTML = ({\n  path,\n  componentPath,\n  htmlComponentRendererPath,\n  isClientOnlyPage = false,\n  directory,\n}) =>\n  new Promise((resolve, reject) => {\n    try {\n      const htmlComponentRenderer = require(htmlComponentRendererPath)\n      if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n        htmlComponentRenderer.default(\n          path,\n          isClientOnlyPage,\n          (_throwAway, htmlString) => {\n            resolve(htmlString)\n          }\n        )\n      } else {\n        htmlComponentRenderer.default(path, (_throwAway, htmlString) => {\n          resolve(htmlString)\n        })\n      }\n    } catch (err) {\n      const stack = err.stack ? err.stack : ``\n\n      // Only generate error pages for webpack errors. If it's not a webpack\n      // error, it's not a user error so probably a system error so we'll just\n      // panic and quit.\n      const regex = /webpack:\\/lib\\//gm\n      const moduleBuildFailed = /Module.build.failed/gm\n      if (stack.match(moduleBuildFailed)) {\n        reject(`500 page`)\n      } else if (!stack.match(regex)) {\n        console.log(`unexpected error while SSRing the path: ${path}`)\n        console.log(err)\n        reject(err)\n      } else {\n        const error = parseError({ err, directory, componentPath })\n        reject(error)\n      }\n    }\n  })\n\nexports.deleteModuleCache = htmlComponentRendererPath => {\n  delete require.cache[require.resolve(htmlComponentRendererPath)]\n}\n\nexports.warmup = () => `warmed`\n"],"file":"render-dev-html-child.js"}